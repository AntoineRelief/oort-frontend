<div class="widget-container">
  <div class="widget-header" *ngIf="!parent">
    {{settings.title}}
    <div class="floating-button" *ngIf="settings.floatingButton && settings.floatingButton.show">
      <button mat-button color="primary" (click)="onFloatingButtonClick()">
        {{settings.floatingButton && settings.floatingButton.name ? settings.floatingButton.name : 'Next'}}
      </button>
    </div>
  </div>
  <kendo-grid id="customGrid" class="widget-content" [autoSize]="false" [data]="gridData" [pageSize]="pageSize"
    [skip]="skip" [loading]="loading" [columnMenu]="true" [reorderable]="true" [sortable]="true" [pageable]="true"
    [sort]="sort" [selectable]="selectableSettings" (selectionChange)="selectionChange($event)"
    (sortChange)="sortChange($event)" (pageChange)="pageChange($event)" filterable="menu" [filter]="filter"
    (filterChange)="filterChange($event)" (cellClick)="cellClickHandler($event)" [resizable]="true">
    <ng-template kendoGridToolbarTemplate position="top">
      <!-- <button (click)="onAdd()" class="k-button" *ngIf="canEdit && settings.canAdd && settings.addTemplate">Add</button> -->
      <button type="button" kendoGridExcelCommand class="k-button">Export</button>
      <button class='k-button' [disabled]="!hasChanges" (click)="onSaveChanges()">Save</button>
      <button class='k-button' [disabled]="!hasChanges" (click)="onCancelChanges()">Cancel</button>
      <ng-container *ngIf="selectedRowsIndex.length > 0">
        <button *ngIf="!settings.actions || settings.actions.delete" class='k-button'
          (click)="onDeleteRow(selectedRowsIndex)" style="float: right">Delete
        </button>
        <button *ngIf="!settings.actions || settings.actions.update" class='k-button'
          (click)="onUpdateRow(selectedRowsIndex)" style="float: right">Update
        </button>
        <button *ngIf="!settings.actions || settings.actions.convert" class='k-button'
          (click)="onConvertRecord(selectedRowsIndex)" style="float: right">Convert
        </button>
      </ng-container>
    </ng-template>
    <ng-container *ngIf="fields.length > 0">
      <kendo-grid-checkbox-column
        *ngIf="!settings.actions || settings.actions.delete || settings.actions.convert || settings.floatingButton.modifySelectedRows"
        [width]="41" [headerClass]="{'text-center': true}" [class]="{'text-center': true}" [resizable]="false"
        [columnMenu]="false" showSelectAll="true">
      </kendo-grid-checkbox-column>

      <ng-container *ngFor="let field of fields">
        <kendo-grid-column *ngIf="field.type !== 'JSON'" [field]="field.name" [title]="field.title"
          [format]="field.format" [editor]="field.editor" [editable]="field.editor && !field.disabled"
          [filter]="field.filter" [filterable]="field.filter" [width]="field.title.length * 7 + 50"
          [minResizableWidth]="50">
          <ng-template kendoGridEditTemplate let-dataItem="dataItem" let-formGroup="formGroup"
            *ngIf="field.editor === 'text'">
            <ng-container *ngIf="field.meta.type === 'text'">
              <textarea rows="2" [formControl]="formGroup.get(field.name)" kendoGridFocusable [name]="field.name"
                class="k-textbox"></textarea>
            </ng-container>
            <ng-container *ngIf="field.meta.type === 'dropdown'">
              <kendo-dropdownlist [data]="field.meta.choices"
                [textField]="field.meta.choicesByUrl ? field.meta.choicesByUrl.text : 'text'"
                [valueField]="field.meta.choicesByUrl ? field.meta.choicesByUrl.value : 'value'" [valuePrimitive]="true"
                [formControl]="formGroup.get(field.name)"></kendo-dropdownlist>
            </ng-container>
          </ng-template>
          <ng-template kendoGridEditTemplate let-dataItem="dataItem" let-formGroup="formGroup"
            *ngIf="field.editor === 'date'">
            <kendo-datepicker [formControl]="formGroup.get(field.name)" [format]="field.format"
              (open)="editionActive = true" (close)="editionActive = false"></kendo-datepicker>
          </ng-template>
          <ng-template kendoGridEditTemplate let-dataItem="dataItem" let-formGroup="formGroup"
            *ngIf="field.editor === 'time'">
            <kendo-timepicker [formControl]="formGroup.get(field.name)" [format]="field.format"
              (open)="editionActive = true" (close)="editionActive = false"></kendo-timepicker>
          </ng-template>
          <ng-template kendoGridEditTemplate let-dataItem="dataItem" let-formGroup="formGroup"
            *ngIf="field.editor === 'datetime'">
            <kendo-datetimepicker [formControl]="formGroup.get(field.name)" [format]="field.format"
              (open)="editionActive = true" (close)="editionActive = false"></kendo-datetimepicker>
          </ng-template>
        </kendo-grid-column>
        <kendo-grid-column-group [title]="field.title" *ngIf="field.type === 'JSON'">
          <kendo-grid-column [columnMenu]="false" [width]="field.title.length * 7 + 50" [minResizableWidth]="50">
            <ng-template kendoGridCellTemplate let-dataItem="dataItem">
              <ul class="matrix-cell">
                <li *ngFor="let row of field.meta.rows">
                  {{ row.label }}
                </li>
              </ul>
            </ng-template>
          </kendo-grid-column>
          <ng-container *ngFor="let column of (field.meta.columns ? field.meta.columns : field.meta.items)">
            <kendo-grid-column [title]="column.label" [columnMenu]="false" [width]="column.label.length * 7 + 50"
              [minResizableWidth]="50">
              <ng-template kendoGridCellTemplate let-dataItem="dataItem">
                <ng-container *ngIf="field.meta.type !== 'multipletext'">
                  <ul class="matrix-cell">
                    <ng-container *ngIf="field.meta.type === 'matrix'">
                      <li *ngFor="let row of field.meta.rows">
                        <input type="radio" kendoRadioButton [checked]="dataItem[field.name] && dataItem[field.name][row.name] === column.name"
                          disabled />
                      </li>
                    </ng-container>
                    <ng-container *ngIf="field.meta.type === 'matrixdropdown'">
                      <li *ngFor="let row of field.meta.rows">
                        <ng-container
                          *ngIf="['text', 'dropdown', 'radiogroup'].includes(column.type) && dataItem[field.name] && dataItem[field.name][row.name]">
                          {{ dataItem[field.name][row.name][column.name] }}
                        </ng-container>
                      </li>
                    </ng-container>
                  </ul>
                </ng-container>
                <ng-container *ngIf="field.meta.type === 'multipletext'">
                  {{ dataItem[field.name][column.name] }}
                </ng-container>
              </ng-template>
              <ng-template kendoGridEditTemplate let-dataItem="dataItem" let-formGroup="formGroup">
                <ul class="matrix-cell">
                  <ng-container *ngIf="field.meta.type === 'matrix'">
                    <li *ngFor="let row of field.meta.rows">
                      <input type="radio" kendoRadioButton [value]="column.name" [name]="field.name + row.name"
                        [formControl]="formGroup.get([field.name, row.name])" />
                    </li>
                  </ng-container>
                  <ng-container *ngIf="field.meta.type === 'matrixdropdown'">
                    <li *ngFor="let row of field.meta.rows">
                      <ng-container *ngIf="column.type === 'text'">
                        <textarea rows="2" [formControl]="formGroup.get([field.name, row.name, column.name])"
                          kendoGridFocusable [name]="row.name" class="k-textbox"></textarea>
                      </ng-container>
                      <ng-container *ngIf="['dropdown', 'radiogroup'].includes(column.type)">
                        <kendo-dropdownlist [data]="field.meta.choices" [textField]="'text'" [valueField]="'value'"
                          [valuePrimitive]="true" [formControl]="formGroup.get([field.name, row.name, column.name])">
                        </kendo-dropdownlist>
                      </ng-container>
                    </li>
                  </ng-container>
                </ul>
              </ng-template>
            </kendo-grid-column>
          </ng-container>
        </kendo-grid-column-group>
      </ng-container>

      <kendo-grid-column *ngIf="hasEnabledActions" [columnMenu]="false" [width]="56">
        <ng-template kendoGridCellTemplate let-idx="rowIndex">
          <button style="text-align: center" kendoButton [icon]="'more-vertical'" [look]="'flat'"
            [matMenuTriggerFor]="menu">
          </button>

          <mat-menu #menu="matMenu">
            <button *ngIf="!settings.actions || settings.actions.delete" mat-menu-item (click)="onDeleteRow([idx])">
              Delete
            </button>
            <button *ngIf="!settings.actions || settings.actions.history" mat-menu-item color="warn"
              (click)="onViewHistory(gridData.data[idx].id)">
              History
            </button>
            <button *ngIf="!settings.actions || settings.actions.convert" mat-menu-item color="warn"
              (click)="onConvertRecord([idx])">
              Convert
            </button>
            <button *ngIf="!settings.actions || settings.actions.update" mat-menu-item color="warn"
              (click)="onUpdateRow(gridData.data[idx].id)">
              Update
            </button>
          </mat-menu>

        </ng-template>
      </kendo-grid-column>
    </ng-container>
    <ng-container *ngIf="detailsField">
      <div *kendoGridDetailTemplate="let dataItem">
        <who-grid [settings]="detailsField" [parent]="dataItem" (childChanged)="reloadData()"></who-grid>
      </div>
    </ng-container>
    <ng-template kendoGridNoRecordsTemplate>
      No record detected.
    </ng-template>
    <kendo-grid-excel [fileName]="excelFileName"></kendo-grid-excel>
  </kendo-grid>
</div>