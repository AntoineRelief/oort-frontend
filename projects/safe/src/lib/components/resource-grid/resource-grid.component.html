<kendo-grid [loading]="loading" [data]="gridData" [autoSize]="false" [pageable]="pagerSettings" [height]="410"
  [selectable]="!readOnly && selectableSettings" (pageChange)="pageChange($event)" kendoGridSelectBy
  [selectedKeys]="selectedRowsIndex" (selectionChange)="selectionChange($event)" [pageSize]="pageSize" [skip]="skip"
  [resizable]="true">
  <ng-template kendoGridToolbarTemplate>
    <input placeholder="Search in all columns..." kendoTextBox (input)="onFilter($event.target)" />
  </ng-template>
  <ng-template kendoGridToolbarTemplate position="top" *ngIf="!readOnly">
    <mat-form-field *ngIf="availableRecords.length > 0">
      <mat-select (selectionChange)="onAdd($event)" placeholder="Add record...">
        <mat-option *ngFor="let data of availableRecords" [value]="data.value">{{data.text}}</mat-option>
      </mat-select>
    </mat-form-field>
  </ng-template>
  <!-- ROW SELECTION -->
  <kendo-grid-checkbox-column [width]="41" [resizable]="false" [columnMenu]="false" [showSelectAll]="multiSelect"
    *ngIf="!readOnly">
  </kendo-grid-checkbox-column>
  <!-- ************************************************************ !-->
  <ng-container *ngFor="let field of fields">
    <!-- SIMPLE QUESTIONS TYPES ( text / comment - resource - dropdown - radiogroup - boolean - numeric - date / datetime / datetime-local / time ) -->
    <kendo-grid-column *ngIf="field && field.type !== 'JSON'" [field]="field.name" [title]="field.title"
      [format]="field.format" [editor]="field.editor" [editable]="field.editor && !field.disabled"
      [filter]="field.filter" [filterable]="field.filter" [width]="field.title.length * 7 + 50"
      [minResizableWidth]="50">
      <!-- DISPLAY -->
      <ng-container *ngIf="field.meta">
        <!-- DISPLAY ( text / comment ) -->
        <ng-template #refSpan kendoGridCellTemplate let-dataItem="dataItem" *ngIf="field.meta.type === 'text'">
          <div translate="yes" class="textbox-container">
            <div #refSpan class="textbox">
              {{getPropertyValue(dataItem, field.name)}}
            </div>
            <div class="expand-text-wrapper" *ngIf="isEllipsisActive(refSpan)">
              <button class="expand-text-button" (click)="onExpandComment(dataItem, field.name)" mat-icon-button>
                <mat-icon class="expand-text-icon" matTooltip="Open in full width">launch
                </mat-icon>
              </button>
            </div>
          </div>
        </ng-template>
        <!-- DISPLAY ( url ) -->
        <ng-template #refSpan kendoGridCellTemplate let-dataItem="dataItem" *ngIf="field.meta.type === 'url'">
          <div class="textbox-container">
            <a class="url-container textbox" href="{{getPropertyValue(dataItem, field.name)}}" target="_blank"
              rel="noopener noreferrer">
              <div #refSpan>
                {{getPropertyValue(dataItem, field.name)}}
              </div>
            </a>
            <div class="expand-text-wrapper" *ngIf="isEllipsisActive(refSpan)">
              <button class="expand-text-button" (click)="onExpandComment(dataItem, field.name)" mat-icon-button>
                <mat-icon class="expand-text-icon" matTooltip="Open in full width">launch
                </mat-icon>
              </button>
            </div>
          </div>
        </ng-template>
        <!-- DISPLAY ( boolean ) -->
        <ng-template kendoGridCellTemplate let-dataItem="dataItem" *ngIf="field.meta.type === 'boolean'">
          <input type="checkbox" kendoCheckBox [(ngModel)]="dataItem[field.name]" disabled />
        </ng-template>
        <!-- DISPLAY ( color ) -->
        <ng-template kendoGridCellTemplate let-dataItem="dataItem" *ngIf="field.meta.type === 'color'">
          <!-- In order to display the div -->
          <div [style.background-color]="dataItem[field.name]">&nbsp;</div>
        </ng-template>
        <!-- DISPLAY ( records ) -->
        <ng-template kendoGridCellTemplate let-dataItem="dataItem" *ngIf="field.meta.type === 'records'">
          <div *ngIf="dataItem[field.name]" class="textbox-container">
            <div #refSpan class="textbox external-link" *ngIf="dataItem[field.name].length > 0" matTooltip="Open detail"
              (click)="onShowDetails(dataItem[field.name], field)">
              {{dataItem[field.name].length}} item<span *ngIf="dataItem[field.name].length > 1">s</span>
            </div>
          </div>
        </ng-template>
        <!-- DISPLAY ( dropdown / radiogroup ) -->
        <ng-template kendoGridCellTemplate let-dataItem="dataItem"
          *ngIf="field.meta.type === 'dropdown' || field.meta.type === 'radiogroup'">
          {{ getPropertyValue(dataItem, field.name) }}
        </ng-template>
      </ng-container>
    </kendo-grid-column>
    <!-- MULTI SELECT QUESTION TYPES ( checkbox / tagbox / owner / users ) -->
    <kendo-grid-column *ngIf="field.type === 'JSON' && multiSelectTypes.includes(field.meta.type)" [field]="field.name"
      [filterable]="true" [title]="field.title" [editor]="field.editor" [editable]="!field.disabled"
      [width]="field.width" [hidden]="field.hidden" [minResizableWidth]="50">
      <ng-template kendoGridCellTemplate let-dataItem="dataItem">
        {{ getPropertyValue(dataItem, field.name) }}
      </ng-template>
      <ng-template kendoGridEditTemplate let-dataItem="dataItem" let-formGroup="formGroup">
        <kendo-multiselect [data]="field.meta.choices" textField="text" valueField="value" [valuePrimitive]="true"
          [formControl]="formGroup.get(field.name)" [autoClose]="false">
        </kendo-multiselect>
      </ng-template>
    </kendo-grid-column>
    <!-- FILE -->
    <kendo-grid-column [title]="field.title" *ngIf="field.type === 'JSON' && field.meta.type === 'file'"
      [columnMenu]="false" [editable]="false" [width]="field.title.length * 7 + 50" [minResizableWidth]="50">
      <ng-template kendoGridCellTemplate let-dataItem="dataItem">
        <button kendoButton icon="file-data" *ngFor="let file of dataItem[field.name]" [look]="'flat'"
          [matTooltip]="file.name" (click)="onDownload(file)"></button>
      </ng-template>
    </kendo-grid-column>
    <!-- COMPLEX QUESTION TYPES ( matrix / matrixdropdown / matrixdynamic / multipletext ) -->
    <kendo-grid-column-group [title]="field.title"
      *ngIf="field.type === 'JSON' && !multiSelectTypes.includes(field.meta.type) && field.meta.type !== 'file'">
      <ng-container *ngIf="!['multipletext', 'matrixdynamic'].includes(field.meta.type)">
        <!-- QUESTION ROWS ( matrix / matrixdropdown ) -->
        <kendo-grid-column [columnMenu]="false" [width]="field.title.length * 7 + 50" [minResizableWidth]="50"
          [editable]="!field.disabled">
          <ng-template kendoGridCellTemplate let-dataItem="dataItem">
            <ul class="matrix-cell">
              <li *ngFor="let row of field.meta.rows">
                {{ row.label }}
              </li>
            </ul>
          </ng-template>
        </kendo-grid-column>
      </ng-container>
      <!-- QUESTION COLUMNS / ITEMS -->
      <ng-container *ngFor="let column of (field.meta.columns ? field.meta.columns : field.meta.items)">
        <kendo-grid-column [title]="column.label" [columnMenu]="false" [width]="column.label.length * 7 + 50"
          [minResizableWidth]="50" [editable]="!field.disabled">
          <ng-template kendoGridCellTemplate let-dataItem="dataItem">
            <!-- DISPLAY ( matrix / matrixdropdown / matrixdynamic ) -->
            <ng-container *ngIf="field.meta.type !== 'multipletext'">
              <ul class="matrix-cell">
                <ng-container *ngIf="field.meta.type === 'matrix'">
                  <li *ngFor="let row of field.meta.rows">
                    <input type="radio" kendoRadioButton
                      [checked]="dataItem[field.name] && dataItem[field.name][row.name] === column.name" disabled />
                  </li>
                </ng-container>
                <ng-container *ngIf="field.meta.type === 'matrixdropdown'">
                  <li *ngFor="let row of field.meta.rows">
                    <ng-container
                      *ngIf="['text', 'dropdown', 'radiogroup'].includes(column.type) && dataItem[field.name] && dataItem[field.name][row.name]">
                      {{ dataItem[field.name][row.name][column.name] }}
                    </ng-container>
                  </li>
                </ng-container>
                <ng-container *ngIf="field.meta.type === 'matrixdynamic'">
                  <li *ngFor="let row of dataItem[field.name]">
                    <ng-container *ngIf="row[column.name] || row[column.name] === false">
                      {{ row[column.name] }}
                    </ng-container>
                  </li>
                </ng-container>
              </ul>
            </ng-container>
            <!-- DISPLAY ( multipletext ) -->
            <ng-container *ngIf="field.meta.type === 'multipletext' && dataItem[field.name]">
              <span translate="yes">{{ dataItem[field.name][column.name] }}</span>
            </ng-container>
          </ng-template>
        </kendo-grid-column>
      </ng-container>
    </kendo-grid-column-group>
  </ng-container>
  <!-- ROW DETAILS -->
  <kendo-grid-column [columnMenu]="false" [width]="56" title="Details">
    <ng-template kendoGridCellTemplate let-dataItem="dataItem">
      <button style="text-align: center" kendoButton [icon]="'detail-section'" [look]="'flat'"
        (click)="onShowDetails(dataItem)" matTooltip="Open detail"></button>
    </ng-template>
  </kendo-grid-column>
  <!-- EMPTY TABLE / INVALID QUERY -->
  <ng-template kendoGridNoRecordsTemplate>
    {{ queryError ? 'Invalid data query.' : 'No record detected.' }}
  </ng-template>
</kendo-grid>